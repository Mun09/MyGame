<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Blockbreak</title>

	<style>
		body {
			height: 100%;
			overflow: hidden;
		}
	</style>

	<script>
        
        function Rad(theta){
            let _rad=theta * Math.PI / 180;

            return _rad;
        }

        class Colider{
            constructor(x1, y1, w, h){
                let init_x = x1-(w/2);
                let init_y = y1-(h/2);

                this.x1 = init_x;
                this.y1 = init_y;
                this.x2 = init_x + w;
                this.y2 = init_y + h;
            }

            Get_x1(){
                return this.x1;
            }
            Get_y1(){
                return this.y1;
            }
            Get_x2(){
                return this.x2;
            }
            Get_y2(){
                return this.y2;
            }
        }

        class Block {
            constructor(x_pos, y_pos, w, h, interval, broke){
                this.x_pos= x_pos;
                this.y_pos=y_pos;
                this.w = w;
                this.h = h;
                this.interval=interval;
                this.broke=broke;
            }
            Get_x_pos(){
                return this.x_pos;
            }
            Get_y_pos(){
                return this.y_pos;
            }
            Get_w(){
                return this.w;
            }
            Get_h(){
                return this.h;
            }
            Get_interval(){
                return this.interval;
            }
            is_Broke(){
                return this.broke;
            }

            Set_x_pos(x){
                 this.x_pos=x;
            }
            Set_y_pos(y){
                 this.y_pos=y;
            }
            Set_Broke(b){
                 this.broke=b;
            }

        }

        class Ball {
            constructor(x_pos, y_pos, r, speed, theta) {
				this.x_pos=x_pos;
				this.y_pos=y_pos;
                this.r=r;
                this.speed=speed;
                this.theta=theta;
            }
            Get_x_pos() {
                return this.x_pos;
            }
            Get_y_pos() {
                return this.y_pos;
            }
            Get_r() {
                return this.r;
            }
            Get_speed() {
                return this.speed;
            }
            Get_theta() {
                return this.theta;
            }
            Set_x_pos(x) {
                this.x_pos=x;
            }
            Set_y_pos(y) {
                this.y_pos=y;
            }
            Set_Speed(_speed){
                this.speed=_speed;
            }

            Move_Ball(speed, theta, _Bar) {
                let rad = Rad(theta);
                let interval_x = -speed * Math.cos(rad) * 0.01;
                let interval_y = -speed * Math.sin(rad) * 0.01;
                this.Set_x_pos(this.Get_x_pos() + interval_x);
                this.Set_y_pos(this.Get_y_pos() + interval_y);

                if(IsCollided_Bar(this, _Bar)) {
                    this.theta = 180 - this.theta;
                }
            }
        }

		class Bar {
			constructor(x_pos, y_pos, w, h){
				this.x_pos=x_pos;
				this.y_pos=y_pos;
				this.w=w;
				this.h=h;
			}
			Get_x_pos(){
				return this.x_pos
			}
			Get_y_pos(){
				return this.y_pos;
			}
			Get_w(){
				return this.w;
			}
			Get_h(){
				return this.h;
			}
			Set_x_pos(x){
				this.x_pos=x;
			}
			Set_y_pos(y){
				this.y_pos=y;
			}
            Move_Bar(interval) {
               _Bar.Set_x_pos(_Bar.Get_x_pos()+interval);
            }
		}

        function create2DArray(rows, columns) {
            var arr = new Array(rows);
            for (var i = 0; i < rows; i++) {
                arr[i] = new Array(columns);
            }
            return arr;
        }

        function Set_Blocks(){
            let height = 10, width = 5;
            let Blocks=create2DArray(height, width);

           for(let i=0; i<height; i++){
                for(let j=0; j<width; j++){
                    let _Block = new Block((1920/2)-100, 100, 40, 40, 10, false); // x, y, w, h, interval, broke
                    let init_x=_Block.Get_x_pos();
                    let init_y=_Block.Get_y_pos();

                    _Block.Set_x_pos(init_x + (_Block.Get_interval()+_Block.Get_w()) * j);
                    _Block.Set_y_pos(init_y + (_Block.Get_interval()+_Block.Get_h()) * i);

                    Blocks[i][j] = _Block;
                }
           }

           return Blocks;
        }
        
        function Draw_Bar(Rect,Bar, x ,y) {
            Rect.fillRect(x, y, Bar.Get_w(), Bar.Get_h());
		}

        function Draw_Blocks(Rect, _Blocks) {
            Rect.fillStyle="#72737c";

            for(let i=0; i<_Blocks.length; i++){
                for(let j=0; j<_Blocks[i].length; j++) {
                    Rect.fillRect(_Blocks[i][j].Get_x_pos(), _Blocks[i][j].Get_y_pos(), _Blocks[i][j].Get_w(), _Blocks[i][j].Get_h());
                }
            }
		}
        
        function Draw_Ball(ctx, _Ball) {
            ctx.beginPath();
            ctx.arc(_Ball.Get_x_pos(), _Ball.Get_y_pos(), _Ball.Get_r(), 0, 2 * Math.PI);
            ctx.fillStyle = "black";
            ctx.fill();
            ctx.closePath();
        }

        function IsCollided_Bar(_Ball, _Bar) {
            let Ball_x = _Ball.Get_x_pos(), Ball_y = _Ball.Get_y_pos();
            let Ball_r = _Ball.Get_r();
            let Bar_x = _Bar.Get_x_pos(), Bar_y = _Bar.Get_y_pos();
            let Bar_h = _Bar.Get_h(), Bar_w = _Bar.Get_w();
            
            let dx = Math.abs(Bar_x - Ball_x);
            let dy = Math.abs(Bar_y - Ball_y);
            let limitX = Bar_h / 2 + Ball_r;
            let limitY = Bar_w / 2;

            if(limitX < dx && limitY < dy) return true;
            return false;
        }

        // Ball이 해당 Block에 부딪치면 true를 반환, 부딪히지 않으면 false를 반환한다.
        function IsCollided_Block(_Ball, _Blocks, index_x, index_y) {
            let thisBlock = _Blocks[index_x][index_y];
            let x_length = Math.abs(_Ball.Get_x_pos() - thisBlock.Get_x_pos());
            let y_length = Math.abs(_Ball.Get_y_pos() - thisBlock.Get_y_pos());

            let x_Max = _Ball.Get_r() + (thisBlock.Get_w() / 2);
            let y_Max = _Ball.Get_r() + (thisBlock.Get_h() / 2);

            if(x_length < x_Max && y_length < y_Max){
            return true;
            } else {
            return false;
            }
        }

        function IndexOfBall(_Ball, height, width) {
            let x = _Ball.x_pos, y = _Ball.y_pos;
            console.log(x, y);
            let i=0, j=0;

            if(y < 100) return [-1, 99];
            for(i=0; i<height; i++) {
                if(y < (100 + 50 + 50 * i)) {
                    break;
                }
            }

            if(x < (1920/2 -100) || x > (1920/2 -100 + 50 * 5)) return [99, -1]; 
            for(j=0; j<height; j++) {
                if(x < ((1920/2 - 100) + 50 + 50 * j)) {
                    break;
                }
            }

            return [i, j];
        }

        function Clear(ctx){
            ctx.fillStyle="white";
            ctx.fillRect(0, 0, 1920, 1080);
        }

        function Update(_Bar, _Ball, Blocks){
            _Ball.Move_Ball(_Ball.Get_speed(), _Ball.Get_theta(), _Bar);

            let height = 10, width = 5;
            let [Ball_index_y, Ball_index_x] = IndexOfBall(_Ball, height, width);
            if(Ball_index_y < 0) return; // y 범위 초과
            if(Ball_index_x < 0) return; // x 범위 초과

            let arr1 = [1, -1, 0, 0], arr2=[0, 0, 1, -1];

            for(let i=0; i<4; i++) {
                let tmpx = arr1[i] + Ball_index_x, tmpy = arr2[i] + Ball_index_y;
                if(tmpx >=0 && tmpx < width && tmpy >= 0 && tmpy < height) {
                    if(IsCollided_Block(_Ball, Blocks, tmpx, tmpy)) {
                        _Ball.speed = -200;
                        return;
                    }
                }
            }

            //IsCollided_Block(_Ball, Blocks);
        }

        function Render(ctx, _Bar, _Ball, _Blocks){
            Clear(ctx);

            Draw_Blocks(ctx, _Blocks);
            Draw_Bar(ctx, _Bar, _Bar.Get_x_pos(), _Bar.Get_y_pos());
            Draw_Ball(ctx, _Ball);
        }

        function Progress(ctx, _Bar, _Ball, _Blocks){
            Update(_Bar, _Ball, _Blocks);
            Render(ctx, _Bar, _Ball, _Blocks);
        }

        function Init(ctx) {
            
        }
	</script>
</head>

<body>
    <canvas id="myCanvas" width="1920" height="1080"></canvas>
    <script>
        const canvas = document.getElementById("myCanvas");

        const ctx = canvas.getContext("2d");

		let _Bar = new Bar(960, 800, 70, 10);
		let _Ball = new Ball(960, 800-10, 7, 200, 90);
        let BlockArray = Set_Blocks();

		window.addEventListener("keydown" , (e) => {

                if(e.key == "ArrowRight"){
                    _Bar.Move_Bar(10);
				}
				if(e.key == "ArrowLeft"){
                    _Bar.Move_Bar(-10);
				}
		});

        setInterval(function () {Progress(ctx, _Bar, _Ball, BlockArray)}, 10);
        
    </script>
</body>
</html>
